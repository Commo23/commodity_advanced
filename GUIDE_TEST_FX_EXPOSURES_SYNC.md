# üß™ **GUIDE DE TEST : Synchronisation FX Exposures**

## üéØ **Objectif**

Tester la synchronisation correcte entre Strategy Builder et FX Exposures apr√®s les corrections appliqu√©es.

---

## üîß **Corrections Appliqu√©es**

### **1. Nettoyage des Anciennes Expositions**
```typescript
// ‚úÖ NOUVEAU : Supprimer les anciennes expositions auto-g√©n√©r√©es avant de cr√©er les nouvelles
serviceRef.current.clearAutoGeneratedExposures();
```

### **2. Transmission du volumeType**
```typescript
// ‚úÖ volumeType transmis du Strategy Builder
volumeType: params.volumeType
```

### **3. Utilisation du Volume Correct**
```typescript
// ‚úÖ Utiliser underlyingExposureVolume (volume total)
const exposureAmount = exposureType === 'receivable' 
  ? underlyingExposureVolume 
  : -underlyingExposureVolume;
```

---

## üìã **Proc√©dure de Test Compl√®te**

### **√âTAPE 1 : Nettoyage Initial**

1. **Ouvrir la Console du Navigateur** (F12)
2. **Aller dans FX Exposures**
3. **Supprimer TOUTES les expositions existantes** (cliquer sur l'ic√¥ne poubelle pour chaque exposition)
4. **V√©rifier** que la page affiche "No FX Exposures Found"

**‚úÖ R√©sultat Attendu :**
```
No FX Exposures Found
Get started by adding your first FX exposure...
```

---

### **√âTAPE 2 : Cr√©er une Nouvelle Strat√©gie (Receivable)**

1. **Aller dans Strategy Builder** (`/strategy-builder`)
2. **Configurer les param√®tres** :
   ```
   EUR Volume: 1,000,000
   USD Volume: 1,085,000
   Volume Type: Receivable ‚úÖ
   Spot Rate: 1.0850
   Months to Hedge: 12
   ```
3. **Ajouter un composant** (ex: Forward ou Call Option)
4. **Cliquer sur "Calculate"**
5. **V√©rifier** que les r√©sultats s'affichent

**‚úÖ R√©sultat Attendu :**
- Calculs affich√©s correctement
- Volume Type = Receivable (visible dans l'interface)

---

### **√âTAPE 3 : Exporter vers Hedging Instruments**

1. **Dans Strategy Builder**, cliquer sur **"Import to Hedging Instruments"**
2. **Entrer un nom** pour la strat√©gie (ex: "Test Receivable Strategy")
3. **Cliquer sur OK**
4. **V√©rifier le message d'alerte** qui confirme l'export

**‚úÖ R√©sultat Attendu :**
```
Strat√©gie "Test Receivable Strategy" import√©e avec succ√®s !
- 12 p√©riodes export√©es
- X composants par p√©riode
```

---

### **√âTAPE 4 : V√©rifier dans FX Exposures**

1. **Aller dans FX Exposures** (`/exposures`)
2. **Attendre 2-3 secondes** pour la synchronisation automatique
3. **V√©rifier la Console** (F12) pour les logs :

**‚úÖ Logs Attendus :**
```
[FX EXPOSURE] Cleared X old auto-generated exposures
Analyzing hedging instruments for new currencies and maturities...
[FX EXPOSURE] EUR-2025-XX-XX: Using underlying exposure volume 1000000 instead of sum of hedging instruments XXXXX
[FX EXPOSURE] Using volumeType from Strategy Builder: receivable
Created auto-exposure for EUR (2025-XX-XX): 1000000
```

4. **V√©rifier les Totaux** :
   ```
   Total Receivables: ‚Ç¨1,000,000 ‚úÖ
   Total Payables: $0 ‚úÖ
   ```

5. **V√©rifier le Tableau** :
   ```
   Currency | Amount      | Type       | Hedge Ratio | Hedged Amount
   EUR      | ‚Ç¨1,000,000  | Receivable | 100%        | ‚Ç¨XXX,XXX
   EUR      | ‚Ç¨1,000,000  | Receivable | 100%        | ‚Ç¨XXX,XXX
   ...
   ```

**‚úÖ Points de Validation :**
- [ ] Type = "Receivable" (PAS "Payable")
- [ ] Montant = ‚Ç¨1,000,000 (PAS ‚Ç¨83,333)
- [ ] Total Receivables = ‚Ç¨1,000,000
- [ ] Total Payables = $0
- [ ] 12 expositions cr√©√©es (une par mois)

---

### **√âTAPE 5 : Test avec Type Payable**

1. **Retourner dans Strategy Builder**
2. **Cr√©er une NOUVELLE strat√©gie** avec :
   ```
   EUR Volume: 500,000
   USD Volume: 542,500
   Volume Type: Payable ‚úÖ
   ```
3. **Exporter** vers Hedging Instruments
4. **Aller dans FX Exposures**
5. **V√©rifier** :

**‚úÖ R√©sultat Attendu :**
```
Total Receivables: ‚Ç¨0 ‚úÖ
Total Payables: ‚Ç¨500,000 ‚úÖ

Currency | Amount      | Type    | Hedge Ratio
EUR      | ‚Ç¨500,000    | Payable | 100%
EUR      | ‚Ç¨500,000    | Payable | 100%
...
```

**‚úÖ Points de Validation :**
- [ ] Anciennes expositions "Receivable" SUPPRIM√âES
- [ ] Nouvelles expositions "Payable" CR√â√âES
- [ ] Type = "Payable"
- [ ] Montant = ‚Ç¨500,000
- [ ] Total Payables = ‚Ç¨500,000
- [ ] Total Receivables = $0

---

### **√âTAPE 6 : Test de Mise √† Jour**

1. **Retourner dans Strategy Builder**
2. **Modifier** le volume :
   ```
   EUR Volume: 2,000,000 (au lieu de 500,000)
   Volume Type: Payable (garder le m√™me)
   ```
3. **Exporter** √† nouveau
4. **Aller dans FX Exposures**
5. **V√©rifier** :

**‚úÖ R√©sultat Attendu :**
```
Total Payables: ‚Ç¨2,000,000 ‚úÖ (mis √† jour)

Currency | Amount      | Type    
EUR      | ‚Ç¨2,000,000  | Payable ‚úÖ (mis √† jour)
```

---

## üîç **Diagnostic des Probl√®mes**

### **Probl√®me 1 : Type Incorrect**

**Sympt√¥me :**
- Strategy Builder : Receivable
- FX Exposures : Payable

**Solution :**
1. V√©rifier dans la console : `[FX EXPOSURE] Using volumeType from Strategy Builder: receivable`
2. Si ce log n'appara√Æt pas, le volumeType n'est pas transmis
3. V√©rifier que vous avez bien s√©lectionn√© le type dans Strategy Builder

---

### **Probl√®me 2 : Montants Incorrects**

**Sympt√¥me :**
- Strategy Builder : ‚Ç¨1,000,000
- FX Exposures : ‚Ç¨83,333

**Solution :**
1. V√©rifier dans la console : `Using underlying exposure volume 1000000`
2. Si le montant est divis√©, `underlyingExposureVolume` n'est pas utilis√©
3. Rafra√Æchir la page et r√©exporter

---

### **Probl√®me 3 : Anciennes Expositions Non Supprim√©es**

**Sympt√¥me :**
- Les anciennes expositions restent apr√®s un nouvel export

**Solution :**
1. V√©rifier dans la console : `Cleared X old auto-generated exposures`
2. Si X = 0, les expositions ne sont pas marqu√©es comme "Auto-Generated"
3. Supprimer manuellement les anciennes expositions
4. R√©exporter depuis Strategy Builder

---

### **Probl√®me 4 : Pas de Synchronisation Automatique**

**Sympt√¥me :**
- Apr√®s l'export, FX Exposures ne se met pas √† jour

**Solution :**
1. **Rafra√Æchir manuellement** en cliquant sur le bouton "Refresh"
2. V√©rifier que l'√©v√©nement `hedgingInstrumentsUpdated` est dispatch√©
3. V√©rifier dans la console s'il y a des erreurs

---

## üìä **Tableau de Validation**

| Test | Attendu | R√©sultat | ‚úÖ/‚ùå |
|------|---------|----------|-------|
| Nettoyage initial | Aucune exposition | | |
| Export Receivable | Type = Receivable | | |
| Montant Receivable | ‚Ç¨1,000,000 | | |
| Total Receivables | ‚Ç¨1,000,000 | | |
| Export Payable | Type = Payable | | |
| Montant Payable | ‚Ç¨500,000 | | |
| Total Payables | ‚Ç¨500,000 | | |
| Anciennes supprim√©es | Receivables = 0 | | |
| Mise √† jour volume | ‚Ç¨2,000,000 | | |

---

## üéØ **Commandes de D√©bogage**

### **Dans la Console du Navigateur**

```javascript
// V√©rifier les expositions actuelles
JSON.parse(localStorage.getItem('fxExposures'))

// V√©rifier les instruments de couverture
JSON.parse(localStorage.getItem('hedgingInstruments'))

// V√©rifier l'√©tat du Strategy Builder
JSON.parse(localStorage.getItem('calculatorState'))

// Supprimer toutes les expositions
localStorage.removeItem('fxExposures')
location.reload()
```

---

## ‚úÖ **Crit√®res de Succ√®s**

Pour que le test soit r√©ussi, TOUS les points suivants doivent √™tre valid√©s :

- [x] **Type de volume** : Respecte le choix du Strategy Builder
- [x] **Montants** : Affiche le volume total (pas divis√©)
- [x] **Totaux** : Receivables et Payables corrects
- [x] **Nettoyage** : Anciennes expositions supprim√©es lors d'un nouvel export
- [x] **Synchronisation** : Mise √† jour automatique apr√®s export
- [x] **Logs** : Messages de d√©bogage clairs dans la console
- [x] **Coh√©rence** : Toutes les expositions d'une m√™me strat√©gie ont le m√™me type

---

## üìû **Support**

### **Si les Tests √âchouent**

1. **Copier les logs** de la console (F12)
2. **Prendre une capture d'√©cran** de FX Exposures
3. **V√©rifier** les donn√©es dans localStorage
4. **Partager** ces informations pour diagnostic

### **Logs Importants √† V√©rifier**

```
‚úÖ [FX EXPOSURE] Cleared X old auto-generated exposures
‚úÖ [FX EXPOSURE] Using underlying exposure volume 1000000
‚úÖ [FX EXPOSURE] Using volumeType from Strategy Builder: receivable
‚úÖ Created auto-exposure for EUR (2025-XX-XX): 1000000
```

**üéØ Si tous ces logs apparaissent et que les donn√©es sont correctes, la synchronisation fonctionne parfaitement !**
